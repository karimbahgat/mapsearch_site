
{% extends "templates/map_view_base.html" %}
{% load static %}

{% load leaflet_tags %}
{% load geojson_tags %}

{% block tab_content %}

<link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

<br>

<table style="width:100%; table-layout: fixed;">
	<tr>
		<td style="font-weight: bold;">Last Digitized:</td>
		<td>{% if form.georeferenced.value %}
				{{ form.georeferenced.value }}
			{% else %}
				Never
			{% endif %}
		</td>
		<td></td>
		<td></td>
		<td>
			<a href="" class="btn btn-primary">
			{% if form.georeferenced.value %}
				Run Again
			{% else %}
				Auto Detect
			{% endif %}
			</a>
		</td>
	</tr>
	<tr>
	<form id="search_map" action="{% url 'map_view' map.pk 'digi' %}" method="get">
		<td>
		<input class="form-control col-md-10" id="search" name="search" type="text" placeholder="Search map..." value="{{ request.GET.search }}">
		</td>
		<td>
		<button class="btn btn-primary" id="search_button" type="submit">Search</button>
		</td>
	</form>
	</tr>
</table>

<br><br>

<div id="map_div">
	{% block extra_assets %}
	  {% leaflet_css %}
	  {% leaflet_js %}
	{% endblock %}

	<script type="text/javascript">
	
	  var layout = {{ form.layout.value|safe }};
	  var texts = [{% for text in map.texts.all %}
			{'type': 'Feature',
			'properties': {},
			'geometry': {{ text.geom|safe }}
			},
		{% endfor %}
	  ];
	  var highlight = {{ highlight|safe }};
	  
	  function map_init(map, options) {
		  // set to pixel crs
		  map.options.crs = L.CRS.Simple;
		  map.options.crs.transformation = new L.Transformation(1, 0, 1, 0);
		  map.options.maxBounds = null;
		  map.options.minZoom = -10; 
		  
		  // add image overlay
		  var imageBounds = [[0,0], [{{ form.height.value }},{{ form.width.value }}]];
		  var imageUrl = '{{ form.url.value }}';
		  var imglyr = L.imageOverlay(imageUrl, imageBounds);
		  imglyr.addTo(map);
		  		  
		  // add layout layer
		  var layoutlyr = L.geoJson(layout, {}).addTo(map);
		  
		  // add text layer
		  var textlyr = L.geoJson(texts, {'color':'black'}).addTo(map);
		  
		  // add highlight layer
		  var highlightlyr = L.geoJson(highlight, {'color':'yellow'}).addTo(map);
		  
		  // layers control
		  L.control.layers({}, {'Map':imglyr, 'Layout':layoutlyr, 'Text':textlyr}, {collapsed:false}).addTo(map);
		  
		  // zoom to extent
		  if (highlightlyr.getBounds().isValid()) {
			highlightBounds = highlightlyr.getBounds();
			map.fitBounds(highlightBounds);
		  } else {
			map.fitBounds(imageBounds);
		  };
		  
		  // refresh map render
		  map.panBy([1,1]);
		  map.invalidateSize();
		  map.panBy([1,1]);
		  
		  // zoom and pan behavior
		  map.options.zoomSnap = 0;
		  //map.options.zoomDelta = 0.1;
		  map.options.wheelPxPerZoomLevel = 40; //40
		  map.options.wheelDebounceTime = 80; //60
		  map.options.maxBoundsViscosity = 1;
	  }
	</script>

	{% leaflet_map "digi_map" callback="window.map_init" %}

</div>

<br>

<div class="alert alert-info" role="alert">
<table style="width:100%">
	<tr>
		<td style="font-weight: bold; vertical-align:top">Layout:</td>
		<td>{{ form.layout }}</td>
	</tr>
</table>
</div> 

{% endblock %}