
{% extends "templates/base.html" %}
{% load static %}

{% load leaflet_tags %}
{% load geojson_tags %}

{% block page_content %}

<link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

<script>
	// flexible drawing functionality
	var map = window.map;
	
	// text drawing
	
	function drawtext_start(onfinish){
		//alert('drawtext start');
		var stopclick = false; //to prevent more than one click listener
		var rect = new L.Draw.Rectangle(map, {shapeOptions: {
													showArea: true,
													color: '#FFF'
													}
												}
											);
		rect.enable();
		function drawtext_create_wrap(e){
			map.off('draw:created', drawtext_create_wrap);
			drawtext_create(e, onfinish);
		};
		map.on('draw:created', drawtext_create_wrap);
	};

	function drawtext_create(e, onfinish){
		//alert('drawtext create');
		drawtext_popup(e, onfinish);
	};

	function drawtext_popup(e, onfinish){
		//alert('drawtext popup');
		// define finish func
		function drawtext_finish(){
			//alert('drawtext finish');
			// run onfinish func
			onfinish();
			// exit
			map.closePopup();
		};
		// define popup
		var content = '<div><input type="hidden" id="id_drawtext_geom" value='+"'"+JSON.stringify(e.layer.toGeoJSON())+"'"+'><input id="id_drawtext_text" type="text"><button id="id_drawtext_finishbut">Add</button></div>';
		var popup = L.popup({closeOnClick:false, closeOnEscapeKey:true});
		popup.setContent(content);
		// open popup at location
		var bounds = e.layer.getBounds();
		var latlng = bounds.getSouthWest();
		popup.setLatLng(latlng);
		map.openPopup(popup);
		// set button onclick func
		document.getElementById("id_drawtext_finishbut").addEventListener("click", drawtext_finish);
		// focus on text input
		document.getElementById("id_drawtext_text").focus();
	};
	
	// text selection
	function selecttext_start(lyr, onfinish){
		//alert('drawtext select');
		// onclick wrapper
		function selecttext_select_wrap(e){
			// unbind click
			lyr.off('click', selecttext_select_wrap);
			// open popup
			var featlyr = e.layer;
			selecttext_popup(e, lyr, featlyr, onfinish)
		};
		// bind click
		lyr.on('click', selecttext_select_wrap);
	};
	
	function selecttext_popup(e, lyr, featlyr, onfinish){
		//alert('drawtext popup');
		// define finish func
		function selecttext_finish(){
			//alert('drawtext finish');
			// run onfinish func
			onfinish();
			// exit
			map.closePopup();
		};
		// define popup
		var content = '<div><input type="hidden" id="id_selecttext_data" value='+"'"+JSON.stringify(featlyr.toGeoJSON())+"'"+'><p>'+featlyr.feature.properties.text+'</p><button id="id_selecttext_finishbut">Select</button><button id="id_selecttext_editbut">Edit</button></div>';
		var popup = L.popup({closeOnClick:false, closeOnEscapeKey:true});
		popup.setContent(content);
		// open popup at location
		var bounds = featlyr.getBounds();
		var latlng = bounds.getSouthWest();
		popup.setLatLng(latlng);
		map.openPopup(popup);
		// set button onclick func
		document.getElementById("id_selecttext_finishbut").addEventListener("click", selecttext_finish);
	};
</script>

<h3>Now Editing Layer: {{ layer.name }}</h3>
<h4>in map: <a href={% url "map_view" map.pk %}>{{ map.filename }}</a></h4>

<div class="alert alert-dark" role="alert">
<h4>Layer Information:</h4>
<form id="id_layerform" action="{% url 'layer_edit' form.initial.id %}" method="post" style="margin-bottom:0">
{% csrf_token %}
<table style="width:100%; table-layout: fixed; margin:10px">
	<tr>
		<th>Name</th>
		<th>Type</th>
		<th>Comment</th>
	</tr>
	<tr>
		<td style="font-weight: bold">Show input & abc button if none, otherwise show hyperlinked text linking to text obj popup{{ form.name }}</td>
		<td>{{ form.type }}</td>
		<td>{{ form.comment }}</td>
	</tr>
</table>
<table style="width:100%; table-layout: fixed; margin:10px">
	<tr>
		<th>Legend Description</th>
		<th>Legend Symbol</th>
		<th></th>
	</tr>
	<tr>
		<td>
			<p><a id="id_legend_description_display" href=""></a></p>
			<input id="id_legend_description" name="legend_description" type="hidden">
			<script>
				var map = window.map;
				
				function new_legend_description(){
					// get geometry
					var geoj = JSON.parse(document.getElementById("id_drawtext_geom").value);
					// set properties
					geoj.properties.text = document.getElementById("id_drawtext_text").value;
					// add to existing textlyr
					window.textlyr.addData(geoj);
					// update
					update_legend_description(geoj);
				};
				
				function select_legend_description(){
					// get geometry
					var geoj = JSON.parse(document.getElementById("id_selecttext_data").value);
					// update
					update_legend_description(geoj);
				};
				
				function update_legend_description(geoj){
					// save as json string
					document.getElementById("id_legend_description").value = JSON.stringify(geoj);
					// update text
					document.getElementById("id_legend_description_display").textContent = geoj.properties.text;
				};
			</script>
			<button type="button" onclick="selecttext_start(window.textlyr, select_legend_description);">Select Text</button>
			<button type="button" onclick="drawtext_start(new_legend_description);">Draw Text</button>
		</td>
		<td>
			<input id="id_legend_symbol" name="legend_symbol" value="{{ layer.legend_symbol|safe }}" type="hidden">
			<script>
				// see example:
				// https://northlandia.wordpress.com/2015/03/27/leaflet-draw-implementing-custom-tools/
				
				var map = window.map;
				
				function drawsymbol_start(){
					//alert('drawsymbol start');
					var stopclick = false; //to prevent more than one click listener
					var rect = new L.Draw.Rectangle(map, {shapeOptions: {
																showArea: true,
																color: '#FFF'
																}
															}
														);
					rect.enable();
					map.on('draw:created', drawsymbol_create);
				};
				
				function drawsymbol_edit(){
					//alert('drawsymbol edit');
					// first delete existing
					// ...
					drawsymbol_start();
				};
				
				function drawsymbol_create(e){
					//alert('drawsymbol create');
					drawsymbol_finish(e);
				};
				
				function drawsymbol_finish(e){
					//alert('drawsymbol finish');
					var data = e.layer.toGeoJSON();
					document.getElementById("id_legend_symbol").value = JSON.stringify(data);
					map.off('draw:created', drawsymbol_create);
					drawsymbol_update_buttons();
				};
				
				function drawsymbol_update_buttons(){
					//alert('drawsymbol update buttons');
					var drawbut = document.getElementById("id_legend_symbol_drawbut");
					var editbut = document.getElementById("id_legend_symbol_editbut");
					if (document.getElementById("id_legend_symbol").value) {
						drawbut.style.display = 'none';
						editbut.style.display = null;
					} else {
						drawbut.style.display = null;
						editbut.style.display = 'none';
					};
				};
			</script>
			
			<button id="id_legend_symbol_editbut" type="button" onclick="drawsymbol_edit();" style="{% if layer.legend_symbol %}{% else %}display:none{% endif %}">
			Edit
			</button>
			
			<button id="id_legend_symbol_drawbut" type="button" onclick="drawsymbol_start();" style="{% if layer.legend_symbol %}display:none{% else %}{% endif %}">
			Draw
			</button>
		</td>
		<td></td>
	</tr>
</table>
<div style="text-align:right">
	<input id="id_features" name="features" value="" type="hidden">
	<script>
		function submitform() {
			// get features data
			var data = window.drawnItems.toGeoJSON();
			document.getElementById("id_features").value = JSON.stringify(data);
			// submit form
			document.getElementById("id_layerform").submit();
		};
	</script>
	<button id="id_submitform" class="btn btn-primary" type="button" onclick="submitform();">
	Finish
	</button>
	or
	<a href="{% url 'map_view' map.pk 'layers' %}" class="btn btn-secondary">
	Cancel
	</a>
</div>
</form>
</div>

<div id="map_div">
	{% block extra_assets %}
	  {% leaflet_css %}
	  {% leaflet_js %}
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha256-siofc4Uwjlra3YWkwthOn8Uj69cNN4aMug/iOHNiRgs=" crossorigin="anonymous"></script>
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha256-XzD3RpaHPv7lzX9qt+2n1j5cWj48O24KsgaGYpKN8x8=" crossorigin="anonymous" />
	{% endblock %}

	<script type="text/javascript">
	
	  var texts = [{% for text in map.texts.all %}
			{'type': 'Feature',
			'properties': {'text':'{{ text.text }}'},
			'geometry': {{ text.geom|safe }}
			},
		{% endfor %}
	  ];
	  var highlight = [{% for feat in highlight %}
						{{ feat.to_geojson|safe }},
					{% endfor %}];
	  
	  function map_init(map, options) {
		  // remember
		  window.map = map;
		  
		  // set to pixel crs
		  map.options.crs = L.CRS.Simple;
		  map.options.crs.transformation = new L.Transformation(1, 0, 1, 0);
		  map.options.maxBounds = L.latLngBounds(L.latLng(-100000,-100000),L.latLng(100000,100000));
		  map.options.minZoom = -10; 
		  
		  // remove existing layers (osm tiles)
		  map.eachLayer(function(layer){
			map.removeLayer(layer);
		  });
		  
		  // add image overlay
		  var imageBounds = [[0,0], [{{ map.height }},{{ map.width }}]];
		  var imageUrl = '{{ map.url }}';
		  var imglyr = L.imageOverlay(imageUrl, imageBounds);
		  imglyr.addTo(map);
		  
		  // add text layer
		  var textlyr = L.geoJson(texts, {'color':'black'}).addTo(map);
		  window.textlyr = textlyr;
		  
		  // add highlight layer
		  var highlight = {{ layer.to_geojson|safe }};
		  var highlightlyr = L.geoJson(highlight, {'color':'yellow'}).addTo(map);
		  
		  // layers control
		  var layersControl = L.control.layers({}, {'Map':imglyr, 'Text':textlyr}, {collapsed:false}).addTo(map);
		  
		  // zoom and pan behavior
		  map.options.zoomSnap = 0;
		  //map.options.zoomDelta = 0.1;
		  map.options.wheelPxPerZoomLevel = 40; //40
		  map.options.wheelDebounceTime = 80; //60
		  map.options.maxBoundsViscosity = 1;
		  
		  // zoom to extent
		  map.fitBounds(imageBounds);
		  
		  // drawing group
		  var drawnItems = L.featureGroup([highlightlyr]).addTo(map);
		  layersControl.addOverlay(drawnItems, 'Layer Features');
		  window.drawnItems = drawnItems; 
		  // drawing controls
		  //map.options.drawControl = true;
		  var drawControl = new L.Control.Draw({
		  draw: {
			polygon: {
			 shapeOptions: {
			  color: 'yellow'
			 },
			},
			polyline: {
			 shapeOptions: {
			  color: 'yellow'
			 },
			},
			rectangle: false,
			circle: false,
			circlemarker: false,
		   },
          edit: {
             featureGroup: drawnItems
          }
		  });
		  map.addControl(drawControl);
		  
		  // add when drawn
		  window.drawfeature = function (e) {
		    alert('drawfeature');
            var type = e.layerType;
            var layer = e.layer;
            drawnItems.addLayer(layer);
		  };
		  //map.on('draw:created', window.drawfeature);
	  }
	</script>

	{% leaflet_map "layers_map" callback="window.map_init" %}
	
	<style>
    .leaflet-container {  /* all maps */
        height: 600px;
    }
	</style>

</div>

<br>

<div class="alert alert-dark" role="alert" style="margin-left:20px">
<h4 class="alert-heading">Features:
<button>New Feature</button>
</h4>
<table style="width:100%" class="table table-dark">
	<tr>
		<th></th>
		<th>GeoJSON</th>
		<th>Label</th>
	</tr>
	{% for feat in layer.features.all %}
	<tr>
		<td><img src="https://cdn2.iconfinder.com/data/icons/geometry-outline/60/42_-Geometric_Form-_geometry_shape_form_drawing-512.png" width=30px style="filter: invert(1)"></td>
		<td>{{ feat.geom }}</td>
		<td>{{ feat.label }}</td>
	</tr>
	{% endfor %}
</table>

</div>

{% endblock %}