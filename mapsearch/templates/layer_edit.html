
{% extends "templates/base.html" %}
{% load static %}

{% load leaflet_tags %}
{% load geojson_tags %}

{% block page_content %}

<link href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

<h3>Now Editing Layer: {{ layer.name }}</h3>
<h4>in map: <a href={% url "map_view" map.pk %}>{{ map.filename }}</a></h4>

<div class="alert alert-dark" role="alert">
<h4>Layer Information:</h4>
<form action="{% url 'layer_edit' form.initial.id %}" method="post">
{% csrf_token %}
<table style="width:100%; table-layout: fixed;">
	<tr>
		<th>Name</th>
		<th>Type</th>
		<th>Comment</th>
	</tr>
	<tr>
		<td style="font-weight: bold; padding:5px">{{ form.name }}</td>
		<td>{{ form.type }}</td>
		<td>{{ form.comment }}</td>
	</tr>
</table>
<table style="width:100%; table-layout: fixed;">
	<tr>
		<th>Legend Symbol</th>
		<th>Legend Description</th>
		<th></th>
	</tr>
	<tr>
		<td>{{ form.legend_symbol }}</td>
		<td>{{ form.legend_description }}</td>
		<td></td>
	</tr>
</table>
<div style="text-align:right">
	<input id="drawnData" name="features" value="" type="hidden">
	<button class="btn btn-primary" type="submit">
	Finish
	</button>
	or
	<a href="{% url 'map_view' map.pk 'layers' %}" class="btn btn-secondary">
	Cancel
	</a>
</div>
</form>
</div>

<div id="map_div">
	{% block extra_assets %}
	  {% leaflet_css %}
	  {% leaflet_js %}
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" integrity="sha256-siofc4Uwjlra3YWkwthOn8Uj69cNN4aMug/iOHNiRgs=" crossorigin="anonymous"></script>
	  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" integrity="sha256-XzD3RpaHPv7lzX9qt+2n1j5cWj48O24KsgaGYpKN8x8=" crossorigin="anonymous" />
	{% endblock %}

	<script type="text/javascript">
	
	  var texts = [{% for text in map.texts.all %}
			{'type': 'Feature',
			'properties': {},
			'geometry': {{ text.geom|safe }}
			},
		{% endfor %}
	  ];
	  var highlight = [{% for feat in highlight %}
						{{ feat.to_geojson|safe }},
					{% endfor %}];
	  
	  function map_init(map, options) {
		  // set to pixel crs
		  map.options.crs = L.CRS.Simple;
		  map.options.crs.transformation = new L.Transformation(1, 0, 1, 0);
		  map.options.maxBounds = L.latLngBounds(L.latLng(-100000,-100000),L.latLng(100000,100000));
		  map.options.minZoom = -10; 
		  
		  // add image overlay
		  var imageBounds = [[0,0], [{{ map.height }},{{ map.width }}]];
		  var imageUrl = '{{ map.url }}';
		  var imglyr = L.imageOverlay(imageUrl, imageBounds);
		  imglyr.addTo(map);
		  
		  // add text layer
		  var textlyr = L.geoJson(texts, {'color':'black'}).addTo(map);
		  
		  // add highlight layer
		  var highlight = {{ layer.to_geojson|safe }};
		  var highlightlyr = L.geoJson(highlight, {'color':'yellow'}).addTo(map);
		  
		  // layers control
		  var layersControl = L.control.layers({}, {'Map':imglyr, 'Text':textlyr}, {collapsed:false}).addTo(map);
		  
		  // zoom and pan behavior
		  map.options.zoomSnap = 0;
		  //map.options.zoomDelta = 0.1;
		  map.options.wheelPxPerZoomLevel = 40; //40
		  map.options.wheelDebounceTime = 80; //60
		  map.options.maxBoundsViscosity = 1;
		  
		  // zoom to extent
		  map.fitBounds(imageBounds);
		  
		  // drawing group
		  var drawnItems = L.featureGroup([highlightlyr]).addTo(map);
		  layersControl.addOverlay(drawnItems, 'Layer Features');
		  window.drawnItems = drawnItems; 
		  // drawing controls
		  //map.options.drawControl = true;
		  var drawControl = new L.Control.Draw({
		  draw: {
			polygon: {
			 shapeOptions: {
			  color: 'yellow'
			 },
			},
			polyline: {
			 shapeOptions: {
			  color: 'yellow'
			 },
			},
			rect: {
			 shapeOptions: {
			  color: 'yellow'
			 },
			},
			circle: {
			 shapeOptions: {
			  color: 'yellow'
			 },
			},
		   },
          edit: {
             featureGroup: drawnItems
          }
		  });
		  map.addControl(drawControl);
		  
		  // add when drawn
		  map.on('draw:created', function (e) {
            var type = e.layerType;
            var layer = e.layer;
            drawnItems.addLayer(layer);
			var data = window.drawnItems.toGeoJSON();
			document.getElementById("drawnData").value = JSON.stringify(data);
		  });
	  }
	</script>

	{% leaflet_map "layers_map" callback="window.map_init" %}
	
	<style>
    .leaflet-container {  /* all maps */
        height: 600px;
    }
	</style>

</div>

<br>

<div class="alert alert-dark" role="alert" style="margin-left:20px">
<h4 class="alert-heading">Features:</h4>
<table style="width:100%" class="table table-dark">
	<tr>
		<th></th>
		<th>GeoJSON</th>
		<th>Label</th>
	</tr>
	{% for feat in layer.features.all %}
	<tr>
		<td><img src="https://cdn2.iconfinder.com/data/icons/geometry-outline/60/42_-Geometric_Form-_geometry_shape_form_drawing-512.png" width=30px style="filter: invert(1)"></td>
		<td>{{ feat.geom }}</td>
		<td>{{ feat.label }}</td>
	</tr>
	{% endfor %}
</table>

</div>

{% endblock %}